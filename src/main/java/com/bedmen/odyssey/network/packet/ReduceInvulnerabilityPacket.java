package com.bedmen.odyssey.network.packet;

import com.bedmen.odyssey.combat.WeaponUtil;
import net.minecraft.client.Minecraft;
import net.minecraft.network.FriendlyByteBuf;
import net.minecraft.world.entity.Entity;
import net.minecraft.world.entity.LivingEntity;
import net.minecraftforge.network.NetworkEvent;

import java.util.function.Supplier;

public class ReduceInvulnerabilityPacket {

    public int id;
    public int ticks;

    public ReduceInvulnerabilityPacket(){
    }

    public ReduceInvulnerabilityPacket(int id, int ticks){
        this.id = id;
        this.ticks = ticks;
    }

    public ReduceInvulnerabilityPacket(LivingEntity livingEntity, int ticks){
        this.id = livingEntity.getId();
        this.ticks = ticks;
    }

    public static void encode(ReduceInvulnerabilityPacket reduceInvulnerabilityPacket, FriendlyByteBuf buf){
        buf.writeVarInt(reduceInvulnerabilityPacket.id);
        buf.writeVarInt(reduceInvulnerabilityPacket.ticks);
    }

    public static ReduceInvulnerabilityPacket decode(FriendlyByteBuf buf){
        return new ReduceInvulnerabilityPacket(buf.readVarInt(), buf.readVarInt());
    }

    public static void handle(ReduceInvulnerabilityPacket reduceInvulnerabilityPacket, Supplier<NetworkEvent.Context> supplier) {
        NetworkEvent.Context context = supplier.get();
        context.enqueueWork(() -> {
            Minecraft minecraft = Minecraft.getInstance();
            if(minecraft.level != null){
                Entity entity = minecraft.level.getEntity(reduceInvulnerabilityPacket.id);
                if(entity instanceof LivingEntity livingEntity){
                    WeaponUtil.setInvulnerability(livingEntity, reduceInvulnerabilityPacket.ticks);
                }
            }
        });
        context.setPacketHandled(true);
    }

}
